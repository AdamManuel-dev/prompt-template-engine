#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running pre-commit hooks..."

# 1. Run linting with zero warnings allowed
echo "üîç Linting..."
yarn lint --max-warnings 0
if [ $? -ne 0 ]; then
  echo "‚ùå ESLint found issues or warnings. Fix them before committing."
  exit 1
fi

# 2. Run formatting check
echo "‚ú® Checking formatting..."
yarn format:check
if [ $? -ne 0 ]; then
  echo "‚ùå Code formatting issues found. Run 'yarn format' to fix."
  exit 1
fi

# 3. TypeScript type check (strict mode)
echo "üìò Checking TypeScript types..."
npm run type-check:strict --silent 2>/dev/null
if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript errors found. Fix them before committing."
  echo "   Run: npm run type-check:strict"
  exit 1
fi

# 4. Check for large files
echo "üìè Checking file sizes..."
for file in $(git diff --cached --name-only --diff-filter=AM | grep -E '\.(ts|tsx)$'); do
  if [ -f "$file" ]; then
    lines=$(wc -l < "$file")
    if [ "$lines" -gt 500 ]; then
      echo "‚ö†Ô∏è  Warning: $file has $lines lines (recommended max: 500)"
    fi
  fi
done

# 5. Check for console.log statements
CONSOLE_COUNT=$(git diff --cached --name-only --diff-filter=AM | xargs grep -l "console\.\(log\|error\|warn\|info\)" 2>/dev/null | wc -l)
if [ "$CONSOLE_COUNT" -gt 0 ]; then
  echo "‚ö†Ô∏è  Warning: Found console statements. Consider using logger utility."
fi

# 6. Check for potential secrets
SECRETS=$(git diff --cached --name-only --diff-filter=AM | xargs grep -E "api_key|apiKey|password|secret|token" 2>/dev/null | grep -v "process.env\|interface\|type" | wc -l)
if [ "$SECRETS" -gt 0 ]; then
  echo "‚ö†Ô∏è  Warning: Potential secrets detected. Use environment variables."
fi

echo "‚úÖ All pre-commit checks passed!"